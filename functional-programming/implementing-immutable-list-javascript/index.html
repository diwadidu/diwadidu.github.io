<!DOCTYPE html><html lang="en-us"><head><meta name="generator" content="Hexo 3.9.0"><title>Implementing an immutable List in JavaScript | Torsten Müller</title><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="description" content="JavaScript offers objects and arrays. Here, I'm implementing a List type,  which uses paradigms from functional programming such as recursion and immutability."><meta name="author" content="Torsten Muller"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="alternate" href="/atom.xml" title="Torsten Müller" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Torsten Müller" type="application/rss+xml">
<link rel="stylesheet" href="/css/prism-cb.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo-container"><div id="crystal-container" class="logo"></div></div><h1>Torsten Müller<!--a(href= config.root, alt= config.title, title= config.title, itemprop='headline')= config.title--></h1><p itemprop="description"></p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name"><a href="/ " alt="Home" title="Home" itemprop="url">Home</a></li><li itemprop="name"><a href="/projects" alt="Projects" title="Projects" itemprop="url">Projects</a></li><li itemprop="name"><a href="/tags" alt="Topics" title="Topics" itemprop="url">Topics</a></li><li itemprop="name"><a href="/about-me" alt="About me" title="About me" itemprop="url">About me</a></li><li itemprop="name"><a href="/de/ueber-mich" alt="Auf Deutsch" title="Auf Deutsch" itemprop="url">Auf Deutsch</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><div class="story-container"><article class="full"><h1 itemprop="headline" class="post-heading">Implementing an immutable List in JavaScript</h1><div class="publish-date right">published Jan 11th, 2020</div><div class="clear"><span class="page-tag-anchor"><a href="/tags/functional-programming" itemprop="url">#functional-programming
&nbsp;&nbsp;</a></span><span class="page-tag-anchor"><a href="/tags/javascript" itemprop="url">#javascript
&nbsp;&nbsp;</a></span></div><span class="post-meta"></span><div id="toc"></div><p>Continuing my little series on functional programming in JavaScript, I’m tackling and implementing 
the <code>List</code> type now and explain how the immutability of that data structure is accomplished, what 
a memory efficient implementation would look like and finally discuss the major functionality
“groups” of this data type. I’m going to base the behavior and API of my implementation on 
the <code>List</code> type in Scala.</p>
<h2 id="How-it-all-works"><a href="#How-it-all-works" class="headerlink" title="How it all works"></a>How it all works</h2><p>One can imagine two different paradigms when implementing an immutable list. The 
first one would be to make a complete copy of the list and then add a node with additional data.
The second one would be to create a new node, prepend it to the existing list and keep everything
else the same. This means that the reference to the original list head still exists and still
points to all the same nodes in the list. The only change is that we have a new list “head”, 
pointing to a new node, which then connects with the previous list’s head node. </p>
<p>The following figure illustrates how that might look in memory, showing the references
for two Lists <code>A</code> and <code>B</code>, which share a good chunk of their data. Here, we have a <code>List B</code> with
four nodes containing the values 1, 2, 4 and 8, respectively. From this list, we created a new
<code>List A</code> by prefixing a new node containing the value 0, so that <code>List A</code> is an extension of 
<code>List B</code>, containing the values 0, 1, 2, 4 and 8.</p>
<p><img src="two-immutable-lists.svg" alt="Two immutable lists with common content"></p>
<p>In principle, both aforementioned paradigms work, but the second one, where we are prepending nodes to an 
existing <code>List</code>, is more efficient. I believe it is easy to see that simply prepending a node
to an existing list occurs in constant time (i.e. <code>O(1)</code>), whereas creating an entirely new 
instance of an existing list by copying and adding a new node would be <code>O(n)</code>, i.e. 
scale with the size of the 
list since we’d have to duplicate each of the <code>n</code> elements once.</p>
<p>This memory and performance efficiency is also the reason to prefer prepending values to a 
list over appending values, since the appending would need to generate a copy of the entire 
list instead of creating just a single new node.</p>
<p>Now with the basic concept out of the way, we can start thinking about </p>
<ol>
<li>how we would go about instantiating such a construct,</li>
<li>what functionality we would want to efficiently work with this data structure and</li>
<li>what the data management implications of each desired method are.</li>
</ol>
<h2 id="Creating-an-instance-of-a-List"><a href="#Creating-an-instance-of-a-List" class="headerlink" title="Creating an instance of a List"></a>Creating an instance of a List</h2><p>When starting to think of the structure of this construct, we can see that we need at least two
things: a node that contains the data and can link to another node, i.e. hold a reference. The
second thing would be some sort of “object” that represents our <code>List</code> made up of these nodes, 
i.e. which holds a reference to the first node in the <code>List</code>.</p>
<h3 id="The-node-of-a-List"><a href="#The-node-of-a-List" class="headerlink" title="The node of a List"></a>The node of a <code>List</code></h3><p>When we think of a <code>List</code>, we can imagine it being comprised of a multitude of container elements,
or nodes, where each one contains a value and a reference to the next node in the list. This
can be expressed as in the following code snippet:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> Node <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> nodeValue <span class="token operator">=</span> val<span class="token punctuation">;</span>
  <span class="token keyword">var</span> nextNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">get</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>skipClone<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>skipClone<span class="token punctuation">)</span> <span class="token operator">?</span> nodeValue <span class="token punctuation">:</span> <span class="token function">cloneNodeValue</span><span class="token punctuation">(</span>nodeValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>bind <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> nextNode <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> nextNode<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Here, we have a constructor function with two private properties, <code>nodeValue</code> and <code>nextNode</code>,
implementing the two properties explained previously. To make the interaction easier, we define a few utility 
functions, to </p>
<ol>
<li>retrieve the node’s value by using <code>get()</code></li>
<li>extend the <code>List</code> by creating a binding between the current and another node in <code>bind()</code> (but
only when that node is not already filled with a value, i.e. contains <code>null</code>)</li>
<li>traverse the list using <code>next()</code>, which simply returns a reference to the node linked to by
the current node.</li>
</ol>
<p>While this is the main functionality, the <code>get()</code> method also allows us to pass a boolean value,
which will either return the current node’s value (when passed <code>true</code>) or, by default, a cloned 
value for cases where the 
type of the contained entity is either an object or an array. The reason for this behavior is that
JavaScript passes arrays and objects by reference, so that if we simply returned the content, we
would enable modifications to the cloned node to affect the original list, which is supposed to
be immutable!</p>
<p>To ensure that immutability, we clone entities passed by reference (objects, arrays) into the new
list, instead of just pointing them to the existing instance. That is accomplished by the 
<code>cloneNodeValue()</code> function, which I’ll list here without going into details of its implementation.</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">cloneNodeValue</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> type <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">case</span> <span class="token string">'Array'</span><span class="token punctuation">:</span>
      <span class="token keyword">var</span> l <span class="token operator">=</span> val<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">var</span> clone <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        clone<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneNodeValue</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> clone<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> <span class="token string">'Object'</span><span class="token punctuation">:</span>
      <span class="token keyword">var</span> k<span class="token punctuation">,</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneNodeValue</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> val<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Now that we have the functionality of a <code>Node</code> squared away, we can start to look at the 
implementation of the actual <code>List</code>:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> ImmutableList <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">var</span> l <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span> i<span class="token punctuation">,</span>
      nn<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Take all the arguments and put them into the list in the order of their appearance.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> l<span class="token number">-1</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> l<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last <span class="token operator">=</span> nn<span class="token punctuation">;</span>
      nn<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> nn<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> param <span class="token operator">=</span> Array<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>slice<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token punctuation">(</span>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bind<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>ImmutableList<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ListProto <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

ImmutableList<span class="token punctuation">.</span>prototype <span class="token operator">=</span> ListProto<span class="token punctuation">;</span>
ImmutableList<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> ImmutableList<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> ImmutableList<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>While this is a fair amount of code, it’s not super complicated, and it uses a few techniques 
already seen in <a href="/functional-programming/implementing-the-option-monad-in-javascript/">implementation of the Option monad</a>.</p>
<p>To allow instantiation without the <code>new</code> keyword, we check in line 3 whether it’s an instance of 
the <code>ImmutableLIst</code>. If not, the <code>else</code> explicitly calls the constructor with <code>new</code> and passes the
arguments on. So either way, we create a new instance with this function.</p>
<p>The actual functionality of the constructor function starting on line 4</p>
<ol>
<li>defines properties for the <code>length</code> of the list, the <code>head</code>, i.e. the first node of the list, 
and a reference to the <code>last</code> node of the list.</li>
<li>loops over all passed parameters, creates a <code>Node</code> for each value and binds the nodes together
to form the <code>List</code> in the <code>for</code> loop starting on line 12.</li>
</ol>
<p>The remainder of the listing shows an object being assigned to <code>ListProto</code>, which will serve as 
the prototype and contain all the methods we’re going to develop which operate on the List’s 
values. The remainder of
the code sets up the prototypal inheritance and exports the constructor function.</p>
<p>Here is how we would create a list:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">let</span> fibonacci <span class="token operator">=</span> <span class="token function">ImmutableList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>So now, we’re able to create a new <code>List</code>, but with the code the way it stands right now, we can’t 
do anything useful with it. Let’s look at what we might reasonably do with our list and how
that functionality would be implemented (in <code>ListProto</code>)</p>
<h2 id="Operators-on-a-List-instance"><a href="#Operators-on-a-List-instance" class="headerlink" title="Operators on a List instance"></a>Operators on a <code>List</code> instance</h2><p>We can roughly partition the functionality of the methods on a <code>List</code> into the following categories:</p>
<ol>
<li>We can extend the existing list by adding nodes or return a subset of the existing list</li>
<li>We have to create a whole new instance of another <code>List</code> because we want to change its node’s values</li>
<li>Transform the <code>List</code> into a different type, e.g. arrays or strings or reduce it into a single
value (e.g. the average of a list of numbers)</li>
<li>Provide information about the list, such as whether a value exists</li>
</ol>
<p>So let’s take this one by one:</p>
<h3 id="Extending-an-existing-list"><a href="#Extending-an-existing-list" class="headerlink" title="Extending an existing list"></a>Extending an existing list</h3><p>All the methods in this section follow the same paradigm: To not create a new list or modify 
nodes in the existing list. Rather, new data is prepended to the existing list, as explained
earlier in this piece, keeping the nodes and the sequence of data of the existing <code>List</code> the
same. References to the “old” <code>List</code> remain, thereby not modifying those lists.</p>
<p>Examples of this functionality are:</p>
<ul>
<li><code>insertHead()</code> takes a value, encapsulates it in a new instance of <code>Node</code>, <em>prepends</em>
it to the existing <code>List</code> and returns a reference to the newly created node, which is the beginning
of the new list. Note that any references to the old “head node” are still valid, and from their
point of view, the <code>List</code> has not changed, containing all the same nodes in the same order.</li>
<li><code>removeHead()</code> does not actually remove a node, it merely returns a new List whose first 
node is a reference to 
the second node in the list. The resulting list therefore does not know about the previous node
and thus looks like a different list, although no new nodes were created or removed.</li>
</ul>
<p>Here is a sample implementation of those two methods:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> ListProto <span class="token operator">=</span> <span class="token punctuation">{</span>

  insertHead<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>head  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  removeHead<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token punctuation">;</span>
    nl<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nl<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment" spellcheck="true">// All other implementation examples are also </span>
  <span class="token comment" spellcheck="true">// part of ListProto</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>So what does it look like if we have a <code>List</code>, then remove the first node and add a new one to 
the resulting <code>List</code>? The following sequence of graphs explains:</p>
<p><img src="insert-and-remove-head.svg" alt="insert and remove head"></p>
<p>Starting with <code>A</code>, we have an instance of <code>ImmutableList</code>. If we now <code>removeHead()</code>,
we get a new instance of <code>ImmutableList</code>, <code>List B</code> where the head points to the second node 
of <code>List A</code>. Performing now an <code>insertHead()</code> on that second <code>List</code>, we end up with yet another
<code>ImmutableList</code> root, which has a node containing the new value, but pointing to the same List 
as before. So all three List instances share the majority of their nodes/elements, which makes
this particular implementation memory efficient as well as performant (as shown previously with
<code>O(1)</code> efficiency for adding/removing a node).</p>
<h3 id="Modifying-the-values-of-a-list-or-their-order"><a href="#Modifying-the-values-of-a-list-or-their-order" class="headerlink" title="Modifying the values of a list, or their order"></a>Modifying the values of a list, or their order</h3><p>The concept shown in the previous section is great and efficient, but it cannot adequately cover
the case, where we need to modify the values in each node of the <code>List</code>, as in the case of
<code>map()</code>, <code>filter()</code>, <code>reverse()</code>, <code>reverseMap()</code> and <code>insertAfter()</code>. Here is a description
of what these methods do:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Functionality</th>
</tr>
</thead>
<tbody><tr>
<td><code>map()</code></td>
<td>Create a new <code>List</code>, where each node’s value is determined by applying a function to the value in the original <code>List</code></td>
</tr>
<tr>
<td><code>filter()</code></td>
<td>Create a new <code>List</code> of entries that satisfy a provided condition</td>
</tr>
<tr>
<td><code>reverse()</code></td>
<td>Inverts the order of the nodes in the <code>List</code></td>
</tr>
<tr>
<td><code>reverseMap()</code></td>
<td>Inverts the <code>List</code>, but also applies a modifier to the value in each node</td>
</tr>
<tr>
<td><code>insertAfter()</code></td>
<td>Finds the first node satisfying a condition and inserts a new node after that located node</td>
</tr>
</tbody></table>
<p>Their implementation would look like this:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">map<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> nl<span class="token punctuation">,</span> fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nl<span class="token punctuation">.</span>head <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nl<span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token function">fct</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nl<span class="token punctuation">.</span>last <span class="token operator">=</span> nl<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
      <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nl<span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> nd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token function">fct</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      nl<span class="token punctuation">.</span>last<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nl<span class="token punctuation">.</span>last <span class="token operator">=</span> nd<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> nl<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nl<span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> newList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

filter<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">// Tail recursive</span>
  <span class="token keyword">var</span> iterate <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token operator">===</span> <span class="token function">fct</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newList<span class="token punctuation">.</span>head <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newList<span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last <span class="token operator">=</span> newList<span class="token punctuation">.</span>head<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last <span class="token operator">=</span> nd<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      newList<span class="token punctuation">.</span>length <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newList<span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newList<span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

reverse<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> rev <span class="token operator">=</span> newList<span class="token punctuation">.</span><span class="token function">insertHead</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> rev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rev<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> rev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

reverseMap<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> rev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> newList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> rev <span class="token operator">=</span> newList<span class="token punctuation">.</span><span class="token function">insertHead</span><span class="token punctuation">(</span><span class="token function">fct</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  rev<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> rev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

insertAfter<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">traverse</span><span class="token punctuation">(</span>nd<span class="token punctuation">,</span> newList<span class="token punctuation">,</span> insertVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nd <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nd <span class="token operator">===</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>insertVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> prevNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>nd<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// Add the current node, as we want to insert AFTER</span>
      newList<span class="token punctuation">.</span>last<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>prevNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// link copy of current node to new node, INSERTING here</span>
      prevNode<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>newNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// Link the new node to the rest of the list, which should be unaltered</span>
      newNode<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nd<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      newList<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token punctuation">;</span>
      newList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newList<span class="token punctuation">.</span>head <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>nd<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>head <span class="token operator">=</span> nn<span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last <span class="token operator">=</span> nn<span class="token punctuation">;</span>
        <span class="token keyword">return</span> traverse<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nd<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newList<span class="token punctuation">,</span> insertVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> nn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>nd<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>nn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newList<span class="token punctuation">.</span>last <span class="token operator">=</span> nn<span class="token punctuation">;</span>
        <span class="token keyword">return</span> traverse<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> nd<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newList<span class="token punctuation">,</span> insertVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">var</span> nl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> traverse<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> nl<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Common among all those methods is the use of recursion to <code>iterate()</code> over the current <code>List</code> and
generate the new one.
This being implemented in JavaScript — which does not optimize tail recursion like <em>Scala</em>, 
for example — it would have been more prudent to use a <code>while</code> loop to
reduce the risk of stack overflows, but
this being about functional programming, this implementation seemed more appropriate.</p>
<p>The code should be self-explanatory, so I will limit myself to go through the implementation
of the <code>filter()</code> method to point out some common features:</p>
<ol>
<li>In each method, we instantiate a new <code>ImmutableList()</code> and add nodes to it</li>
<li>Within each method, we define a nested function <code>iterate()</code> that recursively iterates over nodes
of the current list</li>
<li>The recursive function for <code>filter()</code> receives<ol>
<li>a reference to a node to consider</li>
<li>a reference to the new <code>ImmutableList</code> instance to populate</li>
<li>a predicate function, returning <code>true</code> or <code>false</code>, indicating whether a node should be
present in the new list.</li>
</ol>
</li>
<li>Recursion stops, when the current node’s property linking to the next node contains <code>null</code>, 
which indicates that no next node is available — thereby indicating the end of the list. Refer 
to the <code>next()</code> function in the first listing.</li>
<li>If the passed predicate function returns <code>true</code> when called with the current node’s content,
we add the node to the new <code>List</code> instance created in this function, otherwise</li>
<li>we don’t add the currently considered node to the new list and keep the recursion going.</li>
</ol>
<p>The other four methods follow the same principles, and I will skip a detailed discussion here.</p>
<h3 id="Creating-a-subset-of-the-current-List"><a href="#Creating-a-subset-of-the-current-List" class="headerlink" title="Creating a subset of the current List"></a>Creating a subset of the current <code>List</code></h3><p>We already saw the <code>removeHead()</code> function, but what if we want to create a new <code>List</code> that 
omits more than the head element? To make that use case easier to handle, we have <code>drop()</code> and 
<code>dropWhile()</code>, which create a new list without the first <code>n</code> nodes (<code>drop</code>) or a <code>List</code> starting 
with the first node for which the passed predicate function returns <code>false</code> (<code>dropWhile</code>). Their 
implementation is shown here, again using recursion:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">drop<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> findNewHeadNode <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>headNode<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headNode <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> headNode<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">findNewHeadNode</span><span class="token punctuation">(</span>headNode<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> newList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-</span> num <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newList<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token punctuation">;</span>
    newList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-</span> num<span class="token punctuation">;</span>
    newList<span class="token punctuation">.</span>head <span class="token operator">=</span> <span class="token function">findNewHeadNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newList<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

dropWhile<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> findHeadnode <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>node <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> node<span class="token punctuation">.</span>c<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">===</span> <span class="token function">f</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> findHeadnode<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'node'</span><span class="token punctuation">:</span> node<span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">:</span> node<span class="token punctuation">.</span>c<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> newList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> newHead <span class="token operator">=</span> findHeadnode<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>node<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">,</span> c<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> fct<span class="token punctuation">)</span><span class="token punctuation">;</span>
  newList<span class="token punctuation">.</span>head <span class="token operator">=</span> newHead<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newHead<span class="token punctuation">.</span>node <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    newList<span class="token punctuation">.</span>last <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>last<span class="token punctuation">;</span>
    newList<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">-</span> newHead<span class="token punctuation">.</span>c<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newList<span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Here is a graphic visually explaining what is going on:</p>
<p><img src="drop-and-dropWhile.svg" alt="Using the two drop() methods on a List"></p>
<h3 id="Other-noteworthy-methods-on-the-List"><a href="#Other-noteworthy-methods-on-the-List" class="headerlink" title="Other noteworthy methods on the List"></a>Other noteworthy methods on the <code>List</code></h3><p>The implementation <a href="https://bitbucket.org/tmuller/functional-objects/src/master/" target="_blank" rel="noopener">found on bitbucket</a>
implements a few more methods, of which I will discuss two more, <code>findNode()</code> and <code>foldLeft()</code>:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript">findNode<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">iterate</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> optionPkg<span class="token punctuation">.</span><span class="token function">None</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fct</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> optionPkg<span class="token punctuation">.</span><span class="token function">Some</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

foldLeft<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>initVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>fct<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token keyword">function</span> <span class="token function">iterate</span><span class="token punctuation">(</span>cVal<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> cVal<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span><span class="token function">fct</span><span class="token punctuation">(</span>cVal<span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">iterate</span><span class="token punctuation">(</span>initVal<span class="token punctuation">,</span> self<span class="token punctuation">.</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>The <code>findNode()</code> method iterates through the <code>List</code> until it finds an entry that causes the
predicate function passed to it to return a truthy value. The return type of this method is 
of the <a href="/functional-programming/implementing-the-option-monad-in-javascript/"><code>Option</code> type</a>, 
thereby indicating whether a node was found. If the value is found,
a reference to the node will be returned in a <code>Some</code> type, otherwise a <code>None</code> is returned. It 
should be noted that only the first of potentially several nodes is returned.</p>
<p>The <code>foldLeft()</code> method creates a single value from the entire <code>List</code>, depending on the function
passed to it. It is a curried function that accepts an initial value as its first parameter and
the function used for the processing of every node as its second parameter. This implementation
expects the passed function processing the entries (the second parameter) to take the current
aggregate value as its first parameter and the value to be processed as its second parameter. A
sample implementation would look like this:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> origList <span class="token operator">=</span> <span class="token function">ImmutableList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> processing <span class="token operator">=</span> <span class="token punctuation">(</span>agg<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> agg <span class="token operator">+</span> current<span class="token punctuation">;</span>
<span class="token keyword">const</span> listSum <span class="token operator">=</span> origList<span class="token punctuation">.</span><span class="token function">foldLeft</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">(</span>processing<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// listSum will contain the number 121.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Discussion-and-summary"><a href="#Discussion-and-summary" class="headerlink" title="Discussion and summary"></a>Discussion and summary</h2><p>In this post, I’ve looked at the implementation of an immutable List, commonly used in functional
programming. Along the way, we used other functional programming paradigms such as</p>
<ol>
<li>currying in the <code>foldLeft</code> method</li>
<li>the use of recursion throughout the implementation (instead of <code>while</code> loops, for example)</li>
<li>immutability of the data in the nodes  — there’s only a getter, but no setter method, so 
we can only provide the value of a node when instantiating it.</li>
<li>concepts for keeping a <code>List</code> instance immutable and instead create separate instances 
sharing data where possible.</li>
<li>memory saving concepts when modifying the <code>List</code></li>
</ol>
<p>The benefit of an implementation of a List like this over, say, the standard JavaScript
<code>Array</code> is the immutability of the instance’s nodes and the memory saving implementation
of creating new Lists from existing Lists by sharing the nodes belonging to both Lists.
Developing this example has also helped me to more deeply understand the principles of 
functional programming.</p>
<p>Finally, here is a (somewhat contrived) example on how to use the implementation developed in 
this post:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> initialValues <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">154</span><span class="token punctuation">,</span><span class="token number">117</span><span class="token punctuation">,</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">67</span><span class="token punctuation">,</span><span class="token number">98</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> l <span class="token operator">=</span> <span class="token function">iList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromArray</span><span class="token punctuation">(</span>initialValues<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// [14,28,154,58,98]</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// [7,14,77,29,49]</span>
  <span class="token punctuation">.</span><span class="token function">dropWhile</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">&lt;</span> <span class="token number">70</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// [77,29,49]</span>
  <span class="token punctuation">.</span><span class="token function">foldLeft</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">,</span> curr<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> acc <span class="token operator">+</span> curr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 100 + 155</span>

<span class="token comment" spellcheck="true">// variable l now is of type `Number` with a value of 255</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>In this example, we take advantage of the fact that each method is returning a new instance of
a List, so we can chain our operators accordingly. We start off with a list of numbers, then do 
the following operations on the <code>List</code>:</p>
<ol>
<li>filter out the uneven numbers, creating a <code>List</code> with new nodes, then</li>
<li>divide the remaining numbers by 2, also creating a completely new <code>List</code>, then</li>
<li>create a new pointer to the first node with a value over 69 (i.e. a new pointer
to an existing node in the list),</li>
<li>finally, we create a single number out of the <code>List</code> using <code>foldLeft()</code> — providing an
initial value of <code>100</code> and passing a function for the aggregation of the values.</li>
</ol>
<p>To finish this post, here is a visual representation of this computation:</p>
<p><img src="list-sequence.svg" alt="A visual repredentation of the previous coding example"></p>
</article><span class="prev-post"><a href="/functional-programming/implementing-the-option-monad-in-javascript/" itemprop="url">⇐ Previous Post</a></span><span class="next-post"><a href="/javascript/converting-get-request-data-into-a-json-object/" itemprop="url">Next Post ⇒</a></span></div></main><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-697637-4');ga('send','pageview');
</script><script>let crystalDrawings = [
  'albit.svg', 'apatit.svg', 'axinit.svg', 'benitoit.svg', 'beryll.svg', 'boracit.svg',
  'cahnit.svg', 'calcit.svg', 'calcit2.svg', 'calciumthiosulfat.svg', 'chalkopyrit.svg',
  'dioptas.svg', 'dolomit.svg', 'galenit.svg', 'granat.svg', 'hamatit.svg',
  'hemimorhpit.svg', 'iodsuccinimid.svg', 'natriumperiodat.svg', 'rohrzucker.svg',
  'sodiumchlorate.svg', 'struvit.svg', 'sulfur.svg', 'topas-top.svg', 'topas.svg',
  'weinsaure.svg', 'wulfenit.svg', 'wurtzit.svg', 'zinkblende.svg', 'zirkon.svg'
];
const selection = Math.floor(Math.random() * crystalDrawings.length);
const crystalFileName = '/images/crystals/' + crystalDrawings[selection];
//console.log(selection, crystalDrawings[selection], crystalFileName);
document.getElementById('crystal-container').style.backgroundImage = 'url('+ crystalFileName + ')';</script><script src="/scripts/toc.js" type="text/javascript"></script><script>TocGenerator.renderInto()</script></body></html>